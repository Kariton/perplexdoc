{{ $img := partial "get-resource.html" (dict "name" .Destination "currentPage" .Page ) }}
{{ if not $img }}
    {{ errorf "%v - No image with the (partial) name %s has been found." .Page .Destination }}
{{ end }}
{{ $title := "" }}
{{ with .Title }}
    {{ $title = ( . | $.RenderString)  }}
{{ else }}
    {{ $filepath := path.Split $img.Name }}
    {{ $title = $filepath.File }}
{{ end }}
<span class="embed">
{{ if eq $img.MediaType.SubType "svg" }}
  <img class="img-svg" src="{{ $img.RelPermalink }}" alt="{{ $img.Name }}" title="{{ $title }}">
{{ else }}
    {{/* $ratio := (div (mul $img.Height 1.0) $img.Width) */}}
    {{ $colmin := mul site.Params.layout.xmin site.Params.layout.column }}
    {{ $colmax := mul site.Params.layout.xmax site.Params.layout.column }}
    {{ $measuremobile := mul site.Params.layout.xmax site.Params.layout.measure }}
    {{ $gutter_mobile := mul site.Params.layout.xmaxmobile site.Params.layout.guttermobile }}
    {{ $width_3col := mul site.Params.layout.xmin (add (mul 3 site.Params.layout.column) (mul 4 site.Params.layout.gutter)) }}
    {{ $args := (dict "min" $colmin "max" $measuremobile ) }}
    {{ $widths := partial "img/func/calc-sizes.html" $args }}
    {{ $srcset := slice }}
    {{ range $widths }}
        {{ if le . $img.Width }}
            {{ $i := $img.Resize (printf "%dx" . ) }}
            {{ $src := print ($i.RelPermalink | safeURL) " " $i.Width "w" }}
            {{ $srcset = $srcset | append $src }}
        {{ end }}
    {{ end }}
    {{ $srcset = delimit $srcset "," }}
    {{ $sizes := print "(max-width: " $width_3col "px) calc( 100vw - " (mul 2 $gutter_mobile) "px ), " $colmax "px" }}
    <img src="{{ $img.RelPermalink }}"
         srcset="{{ print $srcset }}"
         sizes="{{ print $sizes }}"
         alt="{{- .Text -}}"
         {{ with $title }}title="{{- . | site.Home.RenderString -}}"{{ end }}
		     loading="lazy"/>
{{ end }}
    {{ with $img.Params.caption }}
      <span class="caption">{{- . | site.Home.RenderString -}}</span>
    {{ end }}
    {{ with $img.Params.attr }}
        {{ $attr := .  }}
        {{- if $img.Params.caption -}} · {{- end -}}
        {{ with $img.Params.attrlink }}<a href="{{ . | safeHTML }}">
			<span class='attr'>{{- $attr | site.Home.RenderString -}}</span></a>
        {{ else }}<span class='attr'>{{- $attr | site.Home.RenderString -}}</span>
        {{ end }}
    {{ end }}
</span>
{{/* width="{{- $img1.Width -}}" height="{{- $img1.Height -}}" */}}
